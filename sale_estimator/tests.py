import pandas as pd

from common.tests.base import PortalBaseTest
from sale_estimator.common.model import SaleEstModel


class SaleEstModelTest(PortalBaseTest):

    data = {
        "prop_id": "EB3CE250B67FF58ABBF2",
        "query": None,
        "beds": 3,
        "baths": 3.0,
        "prop_type3": "condo-apt",
        "building_size": 1962,
        "address": {
            "state_id": "FL",
            "county": "Miami-Dade",
            "city": "Sunny Isles Beach",
            "zip": "33160",
            "lat": 25.923712,
            "lon": -80.121763,
            "place_type": "street_address",
            "formatted_address": "15901 Collins Ave #1003, Sunny Isles Beach, FL, 33160",
        },
        "is_rehab": False,
    }
    comparables = pd.DataFrame(
        [
            {
                "prop_id": "533732B41A5F35E355F9",
                "state_id": "FL",
                "zip": "33160",
                "city": "north-miami-beach",
                "county": "miami-dade",
                "address_line": "17111 Biscayne Blvd #1404",
                "lat": 25.934209,
                "lon": -80.148668,
                "baths": 3.0,
                "beds": 2,
                "block_id": "120860001283",
                "building_size": 1801,
                "prop_type3": "condo-apt",
                "close_date": 1660345702,
                "close_price": 1050000,
                "is_rehab": False,
                "price_per_sqft": 583.0094392004441,
                "days_from_today": 258,
                "month_from_today": 9.0,
                "quarter_from_today": 3.0,
                "months_since": 9.0,
                "distance": 4.0,
                "coastline": "other",
                "population": 39615.0,
                "cl_price": 507000,
                "cl_price_per_sqft": 360.8844683158067,
                "bl_cl_price": 625750.0,
                "bl_cl_price_per_sqft": 431.5338866610041,
            },
            {
                "prop_id": "89F104A477076D53CDF3",
                "state_id": "FL",
                "zip": "33180",
                "city": "aventura",
                "county": "miami-dade",
                "address_line": "2950 NE 188th St #108",
                "lat": 25.9487399,
                "lon": -80.1399679,
                "baths": 3.0,
                "beds": 2,
                "block_id": "120860001312",
                "building_size": 1663,
                "prop_type3": "condo-apt",
                "close_date": 1660345702,
                "close_price": 510000,
                "is_rehab": False,
                "price_per_sqft": 306.67468430547206,
                "days_from_today": 336,
                "month_from_today": 12.0,
                "quarter_from_today": 3.0,
                "months_since": 12.0,
                "distance": 5.0,
                "coastline": "other",
                "population": 32441.0,
                "cl_price": 510000,
                "cl_price_per_sqft": 306.67468430547206,
                "bl_cl_price": 870000.0,
                "bl_cl_price_per_sqft": 505.92480128852185,
            },
            {
                "prop_id": "1FC0E5AFDFCF776EDCC2",
                "state_id": "FL",
                "zip": "33180",
                "city": "aventura",
                "county": "miami-dade",
                "address_line": "21055 Yacht Club Dr #1110",
                "lat": 25.973739151343,
                "lon": -80.1330676319558,
                "baths": 2.0,
                "beds": 2,
                "block_id": "120860001451",
                "building_size": 1696,
                "prop_type3": "condo-apt",
                "close_date": 1660345702,
                "close_price": 675000,
                "is_rehab": False,
                "price_per_sqft": 397.99528301886795,
                "days_from_today": 311,
                "month_from_today": 11.0,
                "quarter_from_today": 3.0,
                "months_since": 11.0,
                "distance": 8.0,
                "coastline": "other",
                "population": 32441.0,
                "cl_price": 574667,
                "cl_price_per_sqft": 341.79913855055264,
                "bl_cl_price": 1125000.0,
                "bl_cl_price_per_sqft": 448.3858110801116,
            },
            {
                "prop_id": "EE046456011B90CD748A",
                "state_id": "FL",
                "zip": "33180",
                "city": "aventura",
                "county": "miami-dade",
                "address_line": "19707 Turnberry Way #23D",
                "lat": 25.958629,
                "lon": -80.12552,
                "baths": 2.0,
                "beds": 3,
                "block_id": "120860001211",
                "building_size": 1887,
                "prop_type3": "condo-apt",
                "close_date": 1660345702,
                "close_price": 530000,
                "is_rehab": False,
                "price_per_sqft": 280.8691043985162,
                "days_from_today": 247,
                "month_from_today": 9.0,
                "quarter_from_today": 3.0,
                "months_since": 9.0,
                "distance": 5.0,
                "coastline": "second",
                "population": 32441.0,
                "cl_price": 467800,
                "cl_price_per_sqft": 355.528430521509,
                "bl_cl_price": 600000.0,
                "bl_cl_price_per_sqft": 315.77349100862665,
            },
            {
                "prop_id": "2F80CE57F6CF7A5D3570",
                "state_id": "FL",
                "zip": "33180",
                "city": "aventura",
                "county": "miami-dade",
                "address_line": "2950 NE 188th St #133",
                "lat": 25.9487399,
                "lon": -80.1399679,
                "baths": 3.0,
                "beds": 2,
                "block_id": "120860001312",
                "building_size": 1663,
                "prop_type3": "condo-apt",
                "close_date": 1660345702,
                "close_price": 518000,
                "is_rehab": False,
                "price_per_sqft": 311.48526758869514,
                "days_from_today": 307,
                "month_from_today": 11.0,
                "quarter_from_today": 3.0,
                "months_since": 11.0,
                "distance": 5.0,
                "coastline": "other",
                "population": 32441.0,
                "cl_price": 574667,
                "cl_price_per_sqft": 341.79913855055264,
                "bl_cl_price": 870000.0,
                "bl_cl_price_per_sqft": 505.92480128852185,
            },
            {
                "prop_id": "7CE57ACA26C542DF62E9",
                "state_id": "FL",
                "zip": "33180",
                "city": "aventura",
                "county": "miami-dade",
                "address_line": "2950 NE 188th St #302",
                "lat": 25.9487399,
                "lon": -80.1399679,
                "baths": 3.0,
                "beds": 2,
                "block_id": "120860001312",
                "building_size": 1552,
                "prop_type3": "condo-apt",
                "close_date": 1660345702,
                "close_price": 755000,
                "is_rehab": False,
                "price_per_sqft": 486.46907216494844,
                "days_from_today": 321,
                "month_from_today": 11.0,
                "quarter_from_today": 3.0,
                "months_since": 11.0,
                "distance": 5.0,
                "coastline": "other",
                "population": 32441.0,
                "cl_price": 574667,
                "cl_price_per_sqft": 341.79913855055264,
                "bl_cl_price": 870000.0,
                "bl_cl_price_per_sqft": 505.92480128852185,
            },
            {
                "prop_id": "7C6157B81156E24F49C1",
                "state_id": "FL",
                "zip": "33180",
                "city": "aventura",
                "county": "miami-dade",
                "address_line": "21055 Yacht Club #409",
                "lat": 25.973739151343,
                "lon": -80.1330676319558,
                "baths": 2.0,
                "beds": 3,
                "block_id": "120860001451",
                "building_size": 1865,
                "prop_type3": "condo-apt",
                "close_date": 1660345702,
                "close_price": 720000,
                "is_rehab": False,
                "price_per_sqft": 386.05898123324397,
                "days_from_today": 322,
                "month_from_today": 11.0,
                "quarter_from_today": 3.0,
                "months_since": 11.0,
                "distance": 8.0,
                "coastline": "other",
                "population": 32441.0,
                "cl_price": 574667,
                "cl_price_per_sqft": 341.79913855055264,
                "bl_cl_price": 1125000.0,
                "bl_cl_price_per_sqft": 448.3858110801116,
            },
        ]
    )

    def test_lgbm(self):
        model = SaleEstModel(conn=None, data=self.data)

        model.cl_price = 167000
        model.cl_price_per_sqft = 269.35483870967744
        model.bl_cl_price = 312500
        model.bl_cl_price_per_sqft = 153.61867298616207
        model.population = 33333

        res = model.estimate(self.comparables)
        self.assertEqual(res["__method"], "lgbm")
        self.assertEqual(res["qty"], 7)
        self.assertEqual(res["pred_max"], 1050000)
        self.assertEqual(res["pred_min"], 510000)
        self.assertEqual(res["est_price"], 618000)
        self.assertEqual(res["price_avg"], 679714)
        self.assertEqual(res["percentile25"], 524000)
        self.assertEqual(res["percentile75"], 737500)
        self.assertEqual(res["price_median"], 675000)
        # TODO test comparables
